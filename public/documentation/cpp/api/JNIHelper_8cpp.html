<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Xuggle: csrc/com/xuggle/ferry/JNIHelper.cpp File Reference</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.5 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="classes.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_699738047d3b635b5df656916dee49ce.html">csrc</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_2cb158fd786e896c09be7d68a3b6a246.html">com</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_f3de956f4e588203bf9fcd5328f2c68a.html">xuggle</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_4444989b0b127fd421af0822d4163a66.html">ferry</a>
  </div>
</div>
<div class="contents">
<h1>JNIHelper.cpp File Reference</h1>
<p>
<code>#include &quot;config.h&quot;</code><br>
<code>#include &quot;<a class="el" href="JNIHelper_8h-source.html">JNIHelper.h</a>&quot;</code><br>
<code>#include &lt;iostream&gt;</code><br>
<code>#include &lt;stdexcept&gt;</code><br>

<p>
<div class="dynheader">
Include dependency graph for JNIHelper.cpp:</div>
<div class="dynsection">
<p><center><img src="JNIHelper_8cpp__incl.png" border="0" usemap="#csrc/com/xuggle/ferry/JNIHelper.cpp_map" alt=""></center>
<map name="csrc/com/xuggle/ferry/JNIHelper.cpp_map">
<area shape="rect" href="JNIHelper_8h.html" title="JNIHelper.h" alt="" coords="117,84,208,111"><area shape="rect" href="Ferry_8h.html" title="com/xuggle/ferry/Ferry.h" alt="" coords="141,161,315,188"><area shape="rect" href="Xuggle_8h.html" title="com/xuggle/Xuggle.h" alt="" coords="151,239,305,265"></map>
</div>

<p>
<a href="JNIHelper_8cpp-source.html">Go to the source code of this file.</a><table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Namespaces</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">namespace &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacecom.html">com</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">namespace &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacecom_1_1xuggle.html">com::xuggle</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">namespace &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacecom_1_1xuggle_1_1ferry.html">com::xuggle::ferry</a></td></tr>

<tr><td colspan="2"><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="JNIHelper_8cpp.html#b2aea00ab8b207e59f04168fa92314c4">GET_PROCESS_ID</a>()&nbsp;&nbsp;&nbsp;(0)</td></tr>

<tr><td colspan="2"><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="JNIHelper_8cpp.html#0288538dcdf3a371625b70e45ebc071f">VSJNI_MemoryManagerInit</a> (JavaVM *aJVM)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="b2aea00ab8b207e59f04168fa92314c4"></a><!-- doxytag: member="JNIHelper.cpp::GET_PROCESS_ID" ref="b2aea00ab8b207e59f04168fa92314c4" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define GET_PROCESS_ID          </td>
          <td>(</td>
&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%">&nbsp;&nbsp;&nbsp;(0)</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="JNIHelper_8cpp-source.html#l00031">31</a> of file <a class="el" href="JNIHelper_8cpp-source.html">JNIHelper.cpp</a>.</p>

</div>
</div><p>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="0288538dcdf3a371625b70e45ebc071f"></a><!-- doxytag: member="JNIHelper.cpp::VSJNI_MemoryManagerInit" ref="0288538dcdf3a371625b70e45ebc071f" args="(JavaVM *aJVM)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void VSJNI_MemoryManagerInit           </td>
          <td>(</td>
          <td class="paramtype">JavaVM *&nbsp;</td>
          <td class="paramname"> <em>aJVM</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="JNIMemoryManager_8cpp-source.html#l00126">126</a> of file <a class="el" href="JNIMemoryManager_8cpp-source.html">JNIMemoryManager.cpp</a>.</p>

<p>Referenced by <a class="el" href="JNIHelper_8cpp-source.html#l00149">com::xuggle::ferry::JNIHelper::setVM()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00127"></a>00127 {
<a name="l00128"></a>00128   sCachedJVM = aJVM;
<a name="l00129"></a>00129 
<a name="l00130"></a>00130 <span class="preprocessor">#ifdef VSJNI_USE_JVM_FOR_MEMMANAGEMENT</span>
<a name="l00131"></a>00131 <span class="preprocessor"></span>
<a name="l00134"></a>00134   <span class="keywordflow">try</span>
<a name="l00135"></a>00135   {
<a name="l00136"></a>00136     <span class="comment">// Now, let's cache the commonly used classes.</span>
<a name="l00137"></a>00137     JNIEnv *env = VSJNI_getEnv();
<a name="l00138"></a>00138     <span class="keywordflow">if</span> (!env)
<a name="l00139"></a>00139       <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">"could not find environment"</span>);
<a name="l00140"></a>00140 
<a name="l00141"></a>00141     jclass cls = env-&gt;FindClass(<span class="stringliteral">"java/nio/ByteBuffer"</span>);
<a name="l00142"></a>00142     <span class="keywordflow">if</span> (!cls)
<a name="l00143"></a>00143       <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">"could not find java.nio.ByteBuffer class"</span>);
<a name="l00144"></a>00144 
<a name="l00145"></a>00145     sByteBufferReferenceClass = (jclass) env-&gt;NewWeakGlobalRef(cls);
<a name="l00146"></a>00146     <span class="keywordflow">if</span> (!sByteBufferReferenceClass)
<a name="l00147"></a>00147       <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">"could not get weak reference for class"</span>);
<a name="l00148"></a>00148 
<a name="l00149"></a>00149     sByteBufferAllocateDirectMethod = env-&gt;GetStaticMethodID(cls,
<a name="l00150"></a>00150         <span class="stringliteral">"allocateDirect"</span>, <span class="stringliteral">"(I)Ljava/nio/ByteBuffer;"</span>);
<a name="l00151"></a>00151     <span class="keywordflow">if</span> (!sByteBufferAllocateDirectMethod)
<a name="l00152"></a>00152       <span class="keywordflow">throw</span> std::runtime_error(
<a name="l00153"></a>00153           <span class="stringliteral">"could not find allocateDirect(int) method in java.nio.ByteBuffer"</span>);
<a name="l00154"></a>00154     env-&gt;DeleteLocalRef(cls);
<a name="l00155"></a>00155     <span class="keywordflow">if</span> (env-&gt;ExceptionCheck())
<a name="l00156"></a>00156       <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">"got exception in jni"</span>);
<a name="l00157"></a>00157 
<a name="l00158"></a>00158     cls = env-&gt;FindClass(<span class="stringliteral">"com/xuggle/ferry/JNIMemoryAllocator"</span>);
<a name="l00159"></a>00159     <span class="keywordflow">if</span> (!cls)
<a name="l00160"></a>00160       <span class="keywordflow">throw</span> std::runtime_error(
<a name="l00161"></a>00161           <span class="stringliteral">"could not find com.xuggle.ferry.JNIMemoryAllocatorclass"</span>);
<a name="l00162"></a>00162 
<a name="l00163"></a>00163     sJNIMemoryAllocatorClass = (jclass) env-&gt;NewWeakGlobalRef(cls);
<a name="l00164"></a>00164     <span class="keywordflow">if</span> (!sJNIMemoryAllocatorClass)
<a name="l00165"></a>00165       <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">"could not get weak reference for class"</span>);
<a name="l00166"></a>00166 
<a name="l00167"></a>00167     sJNIMemoryAllocatorMallocMethod = env-&gt;GetMethodID(cls, <span class="stringliteral">"malloc"</span>, <span class="stringliteral">"(I)[B"</span>);
<a name="l00168"></a>00168     <span class="keywordflow">if</span> (!sJNIMemoryAllocatorMallocMethod)
<a name="l00169"></a>00169       <span class="keywordflow">throw</span> std::runtime_error(
<a name="l00170"></a>00170           <span class="stringliteral">"could not find malloc(int) method in com.xuggle.ferry.JNIMemoryAllocator"</span>);
<a name="l00171"></a>00171     sJNIMemoryAllocatorFreeMethod = env-&gt;GetMethodID(cls, <span class="stringliteral">"free"</span>, <span class="stringliteral">"([B)V"</span>);
<a name="l00172"></a>00172     <span class="keywordflow">if</span> (!sJNIMemoryAllocatorFreeMethod)
<a name="l00173"></a>00173       <span class="keywordflow">throw</span> std::runtime_error(
<a name="l00174"></a>00174           <span class="stringliteral">"could not find free(byte[]) method in com.xuggle.ferry.JNIMemoryAllocator"</span>);
<a name="l00175"></a>00175   }
<a name="l00176"></a>00176   <span class="keywordflow">catch</span> (std::exception e)
<a name="l00177"></a>00177   {
<a name="l00178"></a>00178     <span class="comment">// DON'T HAVE JAVA do memory management.</span>
<a name="l00179"></a>00179     sCachedJVM = 0;
<a name="l00180"></a>00180 <span class="preprocessor">#ifdef VSJNI_MEMMANAGER_DEBUG</span>
<a name="l00181"></a>00181 <span class="preprocessor"></span>    fprintf(stderr,
<a name="l00182"></a>00182         <span class="stringliteral">"got exception initializing jvm; using stdlib for memory allocation\n"</span>);
<a name="l00183"></a>00183 <span class="preprocessor">#endif</span>
<a name="l00184"></a>00184 <span class="preprocessor"></span>  }
<a name="l00185"></a>00185 <span class="preprocessor">#else</span>
<a name="l00186"></a>00186 <span class="preprocessor"></span><span class="preprocessor">#endif // VSJNI_USE_JVM_FOR_MEMMANGEMENT</span>
<a name="l00187"></a>00187 <span class="preprocessor"></span>}
</pre></div>
<p>

</div>
</div><p>
</div>
<hr size="1"><address style="text-align: right;"><small>Generated on Mon Jul 11 07:39:31 2011 for Xuggle by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.5 </small></address>
</body>
</html>
