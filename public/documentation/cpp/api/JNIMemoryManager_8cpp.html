<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Xuggle: csrc/com/xuggle/ferry/JNIMemoryManager.cpp File Reference</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.5 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="classes.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_699738047d3b635b5df656916dee49ce.html">csrc</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_2cb158fd786e896c09be7d68a3b6a246.html">com</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_f3de956f4e588203bf9fcd5328f2c68a.html">xuggle</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_4444989b0b127fd421af0822d4163a66.html">ferry</a>
  </div>
</div>
<div class="contents">
<h1>JNIMemoryManager.cpp File Reference</h1>
<p>
<code>#include &quot;<a class="el" href="JNIMemoryManager_8h-source.html">JNIMemoryManager.h</a>&quot;</code><br>
<code>#include &lt;stdexcept&gt;</code><br>
<code>#include &lt;new&gt;</code><br>
<code>#include &lt;cstdlib&gt;</code><br>
<code>#include &lt;cstring&gt;</code><br>
<code>#include &lt;climits&gt;</code><br>
<code>#include &lt;jni.h&gt;</code><br>
<code>#include &lt;com/xuggle/ferry/config.h&gt;</code><br>
<code>#include &quot;<a class="el" href="Ferry_8h-source.html">Ferry.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="RefCounted_8h-source.html">RefCounted.h</a>&quot;</code><br>

<p>
<div class="dynheader">
Include dependency graph for JNIMemoryManager.cpp:</div>
<div class="dynsection">
<p><center><img src="JNIMemoryManager_8cpp__incl.png" border="0" usemap="#csrc/com/xuggle/ferry/JNIMemoryManager.cpp_map" alt=""></center>
<map name="csrc/com/xuggle/ferry/JNIMemoryManager.cpp_map">
<area shape="rect" href="JNIMemoryManager_8h.html" title="JNIMemoryManager.h" alt="" coords="83,84,237,111"><area shape="rect" href="Ferry_8h.html" title="com/xuggle/ferry/Ferry.h" alt="" coords="91,161,264,188"><area shape="rect" href="RefCounted_8h.html" title="RefCounted.h" alt="" coords="363,84,469,111"><area shape="rect" href="Xuggle_8h.html" title="com/xuggle/Xuggle.h" alt="" coords="100,239,255,265"></map>
</div>

<p>
<a href="JNIMemoryManager_8cpp-source.html">Go to the source code of this file.</a><table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Namespaces</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">namespace &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacecom.html">com</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">namespace &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacecom_1_1xuggle.html">com::xuggle</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">namespace &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacecom_1_1xuggle_1_1ferry.html">com::xuggle::ferry</a></td></tr>

<tr><td colspan="2"><br><h2>Enumerations</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">enum &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="JNIMemoryManager_8cpp.html#2bc18c53a2b2c0da9ad26f81ec2b1088">VSJNIMemoryModel</a> { <br>
&nbsp;&nbsp;<a class="el" href="JNIMemoryManager_8cpp.html#2bc18c53a2b2c0da9ad26f81ec2b108872f2575cab9bf0e807db780c26e7cee1">JAVA_STANDARD_HEAP</a> =  0, 
<a class="el" href="JNIMemoryManager_8cpp.html#2bc18c53a2b2c0da9ad26f81ec2b1088d451741b2de7b9fffcb813b43e33e04e">JAVA_DIRECT_BUFFERS</a> =  1, 
<a class="el" href="JNIMemoryManager_8cpp.html#2bc18c53a2b2c0da9ad26f81ec2b10884ba403fa2575d1b4b6a6d772d760b36f">JAVA_DIRECT_BUFFERS_WITH_STANDARD_HEAP_NOTIFICATION</a> =  2, 
<a class="el" href="JNIMemoryManager_8cpp.html#2bc18c53a2b2c0da9ad26f81ec2b1088679446b77e370444a4c707b53c8b5bbf">NATIVE_BUFFERS</a> =  3, 
<br>
&nbsp;&nbsp;<a class="el" href="JNIMemoryManager_8cpp.html#2bc18c53a2b2c0da9ad26f81ec2b1088911f28fce24e3dd1abc3e8ef9735b031">NATIVE_BUFFERS_WITH_STANDARD_HEAP_NOTIFICATION</a> =  4
<br>
 }</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Must match numbers in JNIMemoryManager.java.  <a href="JNIMemoryManager_8cpp.html#2bc18c53a2b2c0da9ad26f81ec2b1088">More...</a><br></td></tr>
<tr><td colspan="2"><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="JNIMemoryManager_8cpp.html#0288538dcdf3a371625b70e45ebc071f">VSJNI_MemoryManagerInit</a> (JavaVM *aJVM)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">JNIEXPORT void JNICALL&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="JNIMemoryManager_8cpp.html#c9aa7a387dcc3ed5290e94536321d6f9">Java_com_xuggle_ferry_JNIMemoryAllocator_setAllocator</a> (JNIEnv *, jclass, jlong aNativeObj, jobject aMemMgr)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Don't enable this; it turns out that on Mac i86_64 at least during the loading of shared libraries, new linkages can override existing linkages So if a library calls new before we're loaded, then loads us, and then calls delete, the Mac may accidentally call our delete; not good.  <a href="#c9aa7a387dcc3ed5290e94536321d6f9"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">JNIEXPORT jobject JNICALL&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="JNIMemoryManager_8cpp.html#d095a030dc149d7b649b6838f6cad00c">Java_com_xuggle_ferry_JNIMemoryAllocator_getAllocator</a> (JNIEnv *env, jclass, jlong aNativeObj)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">JNIEXPORT jint JNICALL&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="JNIMemoryManager_8cpp.html#06eed159e95cb713106ca8755c6d74c8">Java_com_xuggle_ferry_FerryJNI_getMemoryModel</a> (JNIEnv *, jclass)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">JNIEXPORT void JNICALL&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="JNIMemoryManager_8cpp.html#c47335a2c5bbecf640de6d533f636d3d">Java_com_xuggle_ferry_FerryJNI_setMemoryModel</a> (JNIEnv *, jclass, jint value)</td></tr>

</table>
<hr><h2>Enumeration Type Documentation</h2>
<a class="anchor" name="2bc18c53a2b2c0da9ad26f81ec2b1088"></a><!-- doxytag: member="JNIMemoryManager.cpp::VSJNIMemoryModel" ref="2bc18c53a2b2c0da9ad26f81ec2b1088" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">enum <a class="el" href="JNIMemoryManager_8cpp.html#2bc18c53a2b2c0da9ad26f81ec2b1088">VSJNIMemoryModel</a>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Must match numbers in JNIMemoryManager.java. 
<p>
<dl compact><dt><b>Enumerator: </b></dt><dd>
<table border="0" cellspacing="2" cellpadding="0">
<tr><td valign="top"><em><a class="anchor" name="2bc18c53a2b2c0da9ad26f81ec2b108872f2575cab9bf0e807db780c26e7cee1"></a><!-- doxytag: member="JAVA_STANDARD_HEAP" ref="2bc18c53a2b2c0da9ad26f81ec2b108872f2575cab9bf0e807db780c26e7cee1" args="" -->JAVA_STANDARD_HEAP</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" name="2bc18c53a2b2c0da9ad26f81ec2b1088d451741b2de7b9fffcb813b43e33e04e"></a><!-- doxytag: member="JAVA_DIRECT_BUFFERS" ref="2bc18c53a2b2c0da9ad26f81ec2b1088d451741b2de7b9fffcb813b43e33e04e" args="" -->JAVA_DIRECT_BUFFERS</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" name="2bc18c53a2b2c0da9ad26f81ec2b10884ba403fa2575d1b4b6a6d772d760b36f"></a><!-- doxytag: member="JAVA_DIRECT_BUFFERS_WITH_STANDARD_HEAP_NOTIFICATION" ref="2bc18c53a2b2c0da9ad26f81ec2b10884ba403fa2575d1b4b6a6d772d760b36f" args="" -->JAVA_DIRECT_BUFFERS_WITH_STANDARD_HEAP_NOTIFICATION</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" name="2bc18c53a2b2c0da9ad26f81ec2b1088679446b77e370444a4c707b53c8b5bbf"></a><!-- doxytag: member="NATIVE_BUFFERS" ref="2bc18c53a2b2c0da9ad26f81ec2b1088679446b77e370444a4c707b53c8b5bbf" args="" -->NATIVE_BUFFERS</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" name="2bc18c53a2b2c0da9ad26f81ec2b1088911f28fce24e3dd1abc3e8ef9735b031"></a><!-- doxytag: member="NATIVE_BUFFERS_WITH_STANDARD_HEAP_NOTIFICATION" ref="2bc18c53a2b2c0da9ad26f81ec2b1088911f28fce24e3dd1abc3e8ef9735b031" args="" -->NATIVE_BUFFERS_WITH_STANDARD_HEAP_NOTIFICATION</em>&nbsp;</td><td>
</td></tr>
</table>
</dl>

<p>Definition at line <a class="el" href="JNIMemoryManager_8cpp-source.html#l00062">62</a> of file <a class="el" href="JNIMemoryManager_8cpp-source.html">JNIMemoryManager.cpp</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00063"></a>00063 {
<a name="l00064"></a>00064   <a class="code" href="JNIMemoryManager_8cpp.html#2bc18c53a2b2c0da9ad26f81ec2b108872f2575cab9bf0e807db780c26e7cee1">JAVA_STANDARD_HEAP</a> = 0,
<a name="l00065"></a>00065   <a class="code" href="JNIMemoryManager_8cpp.html#2bc18c53a2b2c0da9ad26f81ec2b1088d451741b2de7b9fffcb813b43e33e04e">JAVA_DIRECT_BUFFERS</a> = 1,
<a name="l00066"></a>00066   <a class="code" href="JNIMemoryManager_8cpp.html#2bc18c53a2b2c0da9ad26f81ec2b10884ba403fa2575d1b4b6a6d772d760b36f">JAVA_DIRECT_BUFFERS_WITH_STANDARD_HEAP_NOTIFICATION</a> = 2,
<a name="l00067"></a>00067   <a class="code" href="JNIMemoryManager_8cpp.html#2bc18c53a2b2c0da9ad26f81ec2b1088679446b77e370444a4c707b53c8b5bbf">NATIVE_BUFFERS</a> = 3,
<a name="l00068"></a>00068   <a class="code" href="JNIMemoryManager_8cpp.html#2bc18c53a2b2c0da9ad26f81ec2b1088911f28fce24e3dd1abc3e8ef9735b031">NATIVE_BUFFERS_WITH_STANDARD_HEAP_NOTIFICATION</a> = 4,
<a name="l00069"></a>00069 };
</pre></div>
<p>

</div>
</div><p>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="06eed159e95cb713106ca8755c6d74c8"></a><!-- doxytag: member="JNIMemoryManager.cpp::Java_com_xuggle_ferry_FerryJNI_getMemoryModel" ref="06eed159e95cb713106ca8755c6d74c8" args="(JNIEnv *, jclass)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">JNIEXPORT jint JNICALL Java_com_xuggle_ferry_FerryJNI_getMemoryModel           </td>
          <td>(</td>
          <td class="paramtype">JNIEnv *&nbsp;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">jclass&nbsp;</td>
          <td class="paramname"></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="JNIMemoryManager_8cpp-source.html#l00756">756</a> of file <a class="el" href="JNIMemoryManager_8cpp-source.html">JNIMemoryManager.cpp</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00757"></a>00757 {
<a name="l00758"></a>00758   <span class="keywordflow">return</span> (jint) sVSJNI_IsMirroringNativeMemoryInJVM;
<a name="l00759"></a>00759 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="c47335a2c5bbecf640de6d533f636d3d"></a><!-- doxytag: member="JNIMemoryManager.cpp::Java_com_xuggle_ferry_FerryJNI_setMemoryModel" ref="c47335a2c5bbecf640de6d533f636d3d" args="(JNIEnv *, jclass, jint value)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">JNIEXPORT void JNICALL Java_com_xuggle_ferry_FerryJNI_setMemoryModel           </td>
          <td>(</td>
          <td class="paramtype">JNIEnv *&nbsp;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">jclass&nbsp;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">jint&nbsp;</td>
          <td class="paramname"> <em>value</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="JNIMemoryManager_8cpp-source.html#l00762">762</a> of file <a class="el" href="JNIMemoryManager_8cpp-source.html">JNIMemoryManager.cpp</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00763"></a>00763 {
<a name="l00764"></a>00764 <span class="preprocessor">#ifdef VSJNI_USE_JVM_FOR_MEMMANAGEMENT</span>
<a name="l00765"></a>00765 <span class="preprocessor"></span>  sVSJNI_IsMirroringNativeMemoryInJVM = (<span class="keyword">enum</span> <a class="code" href="JNIMemoryManager_8cpp.html#2bc18c53a2b2c0da9ad26f81ec2b1088" title="Must match numbers in JNIMemoryManager.java.">VSJNIMemoryModel</a>) value;
<a name="l00766"></a>00766 <span class="preprocessor">#endif</span>
<a name="l00767"></a>00767 <span class="preprocessor"></span>}
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="d095a030dc149d7b649b6838f6cad00c"></a><!-- doxytag: member="JNIMemoryManager.cpp::Java_com_xuggle_ferry_JNIMemoryAllocator_getAllocator" ref="d095a030dc149d7b649b6838f6cad00c" args="(JNIEnv *env, jclass, jlong aNativeObj)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">JNIEXPORT jobject JNICALL Java_com_xuggle_ferry_JNIMemoryAllocator_getAllocator           </td>
          <td>(</td>
          <td class="paramtype">JNIEnv *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">jclass&nbsp;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">jlong&nbsp;</td>
          <td class="paramname"> <em>aNativeObj</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="JNIMemoryManager_8cpp-source.html#l00743">743</a> of file <a class="el" href="JNIMemoryManager_8cpp-source.html">JNIMemoryManager.cpp</a>.</p>

<p>References <a class="el" href="RefCounted_8cpp-source.html#l00057">com::xuggle::ferry::RefCounted::getJavaAllocator()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00745"></a>00745 {
<a name="l00746"></a>00746   <span class="comment">// assume that the native object is a RefCounted</span>
<a name="l00747"></a>00747   <a class="code" href="classcom_1_1xuggle_1_1ferry_1_1RefCounted.html" title="Parent of all Ferry objects -- it mains reference counts in native code.">com::xuggle::ferry::RefCounted</a> *obj =
<a name="l00748"></a>00748       *(<a class="code" href="classcom_1_1xuggle_1_1ferry_1_1RefCounted.html" title="Parent of all Ferry objects -- it mains reference counts in native code.">com::xuggle::ferry::RefCounted</a>**) &amp;aNativeObj;
<a name="l00749"></a>00749   jobject result = (jobject) obj-&gt;<a class="code" href="classcom_1_1xuggle_1_1ferry_1_1RefCounted.html#c72c1232baf8544ee28ee36f882ae12d" title="This method is public but not part of the standard API.">getJavaAllocator</a>();
<a name="l00750"></a>00750   <span class="keywordflow">if</span> (result)
<a name="l00751"></a>00751     result = env-&gt;NewLocalRef(result);
<a name="l00752"></a>00752   <span class="keywordflow">return</span> result;
<a name="l00753"></a>00753 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="c9aa7a387dcc3ed5290e94536321d6f9"></a><!-- doxytag: member="JNIMemoryManager.cpp::Java_com_xuggle_ferry_JNIMemoryAllocator_setAllocator" ref="c9aa7a387dcc3ed5290e94536321d6f9" args="(JNIEnv *, jclass, jlong aNativeObj, jobject aMemMgr)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">JNIEXPORT void JNICALL Java_com_xuggle_ferry_JNIMemoryAllocator_setAllocator           </td>
          <td>(</td>
          <td class="paramtype">JNIEnv *&nbsp;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">jclass&nbsp;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">jlong&nbsp;</td>
          <td class="paramname"> <em>aNativeObj</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">jobject&nbsp;</td>
          <td class="paramname"> <em>aMemMgr</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Don't enable this; it turns out that on Mac i86_64 at least during the loading of shared libraries, new linkages can override existing linkages So if a library calls new before we're loaded, then loads us, and then calls delete, the Mac may accidentally call our delete; not good. 
<p>
Here are some JNI functions used by the JNIMemoryAllocator.java method 
<p>Definition at line <a class="el" href="JNIMemoryManager_8cpp-source.html#l00733">733</a> of file <a class="el" href="JNIMemoryManager_8cpp-source.html">JNIMemoryManager.cpp</a>.</p>

<p>References <a class="el" href="RefCounted_8cpp-source.html#l00046">com::xuggle::ferry::RefCounted::setJavaAllocator()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00735"></a>00735 {
<a name="l00736"></a>00736   <span class="comment">// assume that the native object is a RefCounted</span>
<a name="l00737"></a>00737   <a class="code" href="classcom_1_1xuggle_1_1ferry_1_1RefCounted.html" title="Parent of all Ferry objects -- it mains reference counts in native code.">com::xuggle::ferry::RefCounted</a> *obj =
<a name="l00738"></a>00738       *(<a class="code" href="classcom_1_1xuggle_1_1ferry_1_1RefCounted.html" title="Parent of all Ferry objects -- it mains reference counts in native code.">com::xuggle::ferry::RefCounted</a>**) &amp;aNativeObj;
<a name="l00739"></a>00739   obj-&gt;<a class="code" href="classcom_1_1xuggle_1_1ferry_1_1RefCounted.html#120cf9de6dd0cfec3cad071f53306002" title="This method is public but not part of the standard API.">setJavaAllocator</a>(aMemMgr);
<a name="l00740"></a>00740 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="0288538dcdf3a371625b70e45ebc071f"></a><!-- doxytag: member="JNIMemoryManager.cpp::VSJNI_MemoryManagerInit" ref="0288538dcdf3a371625b70e45ebc071f" args="(JavaVM *aJVM)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void VSJNI_MemoryManagerInit           </td>
          <td>(</td>
          <td class="paramtype">JavaVM *&nbsp;</td>
          <td class="paramname"> <em>aJVM</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="JNIMemoryManager_8cpp-source.html#l00126">126</a> of file <a class="el" href="JNIMemoryManager_8cpp-source.html">JNIMemoryManager.cpp</a>.</p>

<p>Referenced by <a class="el" href="JNIHelper_8cpp-source.html#l00149">com::xuggle::ferry::JNIHelper::setVM()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00127"></a>00127 {
<a name="l00128"></a>00128   sCachedJVM = aJVM;
<a name="l00129"></a>00129 
<a name="l00130"></a>00130 <span class="preprocessor">#ifdef VSJNI_USE_JVM_FOR_MEMMANAGEMENT</span>
<a name="l00131"></a>00131 <span class="preprocessor"></span>
<a name="l00134"></a>00134   <span class="keywordflow">try</span>
<a name="l00135"></a>00135   {
<a name="l00136"></a>00136     <span class="comment">// Now, let's cache the commonly used classes.</span>
<a name="l00137"></a>00137     JNIEnv *env = VSJNI_getEnv();
<a name="l00138"></a>00138     <span class="keywordflow">if</span> (!env)
<a name="l00139"></a>00139       <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">"could not find environment"</span>);
<a name="l00140"></a>00140 
<a name="l00141"></a>00141     jclass cls = env-&gt;FindClass(<span class="stringliteral">"java/nio/ByteBuffer"</span>);
<a name="l00142"></a>00142     <span class="keywordflow">if</span> (!cls)
<a name="l00143"></a>00143       <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">"could not find java.nio.ByteBuffer class"</span>);
<a name="l00144"></a>00144 
<a name="l00145"></a>00145     sByteBufferReferenceClass = (jclass) env-&gt;NewWeakGlobalRef(cls);
<a name="l00146"></a>00146     <span class="keywordflow">if</span> (!sByteBufferReferenceClass)
<a name="l00147"></a>00147       <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">"could not get weak reference for class"</span>);
<a name="l00148"></a>00148 
<a name="l00149"></a>00149     sByteBufferAllocateDirectMethod = env-&gt;GetStaticMethodID(cls,
<a name="l00150"></a>00150         <span class="stringliteral">"allocateDirect"</span>, <span class="stringliteral">"(I)Ljava/nio/ByteBuffer;"</span>);
<a name="l00151"></a>00151     <span class="keywordflow">if</span> (!sByteBufferAllocateDirectMethod)
<a name="l00152"></a>00152       <span class="keywordflow">throw</span> std::runtime_error(
<a name="l00153"></a>00153           <span class="stringliteral">"could not find allocateDirect(int) method in java.nio.ByteBuffer"</span>);
<a name="l00154"></a>00154     env-&gt;DeleteLocalRef(cls);
<a name="l00155"></a>00155     <span class="keywordflow">if</span> (env-&gt;ExceptionCheck())
<a name="l00156"></a>00156       <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">"got exception in jni"</span>);
<a name="l00157"></a>00157 
<a name="l00158"></a>00158     cls = env-&gt;FindClass(<span class="stringliteral">"com/xuggle/ferry/JNIMemoryAllocator"</span>);
<a name="l00159"></a>00159     <span class="keywordflow">if</span> (!cls)
<a name="l00160"></a>00160       <span class="keywordflow">throw</span> std::runtime_error(
<a name="l00161"></a>00161           <span class="stringliteral">"could not find com.xuggle.ferry.JNIMemoryAllocatorclass"</span>);
<a name="l00162"></a>00162 
<a name="l00163"></a>00163     sJNIMemoryAllocatorClass = (jclass) env-&gt;NewWeakGlobalRef(cls);
<a name="l00164"></a>00164     <span class="keywordflow">if</span> (!sJNIMemoryAllocatorClass)
<a name="l00165"></a>00165       <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">"could not get weak reference for class"</span>);
<a name="l00166"></a>00166 
<a name="l00167"></a>00167     sJNIMemoryAllocatorMallocMethod = env-&gt;GetMethodID(cls, <span class="stringliteral">"malloc"</span>, <span class="stringliteral">"(I)[B"</span>);
<a name="l00168"></a>00168     <span class="keywordflow">if</span> (!sJNIMemoryAllocatorMallocMethod)
<a name="l00169"></a>00169       <span class="keywordflow">throw</span> std::runtime_error(
<a name="l00170"></a>00170           <span class="stringliteral">"could not find malloc(int) method in com.xuggle.ferry.JNIMemoryAllocator"</span>);
<a name="l00171"></a>00171     sJNIMemoryAllocatorFreeMethod = env-&gt;GetMethodID(cls, <span class="stringliteral">"free"</span>, <span class="stringliteral">"([B)V"</span>);
<a name="l00172"></a>00172     <span class="keywordflow">if</span> (!sJNIMemoryAllocatorFreeMethod)
<a name="l00173"></a>00173       <span class="keywordflow">throw</span> std::runtime_error(
<a name="l00174"></a>00174           <span class="stringliteral">"could not find free(byte[]) method in com.xuggle.ferry.JNIMemoryAllocator"</span>);
<a name="l00175"></a>00175   }
<a name="l00176"></a>00176   <span class="keywordflow">catch</span> (std::exception e)
<a name="l00177"></a>00177   {
<a name="l00178"></a>00178     <span class="comment">// DON'T HAVE JAVA do memory management.</span>
<a name="l00179"></a>00179     sCachedJVM = 0;
<a name="l00180"></a>00180 <span class="preprocessor">#ifdef VSJNI_MEMMANAGER_DEBUG</span>
<a name="l00181"></a>00181 <span class="preprocessor"></span>    fprintf(stderr,
<a name="l00182"></a>00182         <span class="stringliteral">"got exception initializing jvm; using stdlib for memory allocation\n"</span>);
<a name="l00183"></a>00183 <span class="preprocessor">#endif</span>
<a name="l00184"></a>00184 <span class="preprocessor"></span>  }
<a name="l00185"></a>00185 <span class="preprocessor">#else</span>
<a name="l00186"></a>00186 <span class="preprocessor"></span><span class="preprocessor">#endif // VSJNI_USE_JVM_FOR_MEMMANGEMENT</span>
<a name="l00187"></a>00187 <span class="preprocessor"></span>}
</pre></div>
<p>

</div>
</div><p>
</div>
<hr size="1"><address style="text-align: right;"><small>Generated on Mon Jul 11 07:39:31 2011 for Xuggle by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.5 </small></address>
</body>
</html>
